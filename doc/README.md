# Документация omoide-sync

## Как работает

Сервис выполнен в виде скрипта, его можно запускать вручную или делать это
автоматическими средствами (например через `cron`).

Для работы сервис необходимо настроить через переменные окружения.

Вам надо сообщить сервису за каким каталогом следить, а также предоставить
логин и пароль для вашего пользователя на сайте (или сразу нескольких
пользователей). Когда сервис запустится, он проверит вложенные каталоги и файлы
и, при обнаружении новых, загрузит их на сайт.

## Как должен выглядеть локальный каталог

Каталог отслеживания должен быть структурирован следующим образом:

```
Корневой каталог
├───Пользователь 1
│   └───Смешные коты
│       ├───Картинка1.jpg
│       └───Картинка2.jpg
└───Пользователь 2
    └───Фотографии с жабами
        ├───Картинка1.jpg
        └───Картинка2.jpg
```

На верхнем уровне должны находиться каталоги пользователей. Минимум один, но
также поддерживается несколько пользователей (если у вас есть несколько
несвязанных друг с другом больших тем для картинок).

Внутри пользователей может быть сколько угодно вложенных папок с картинками.
Имя каталога должно строго совпадать с названием коллекции. Сервис будет
сравнивать содержимое каталога с данными на сайте и, при необходимости, будет
создавать на сайте новые коллекции. Удалять данные сервис не умеет, он
используется только для добавления новых картинок и коллекций.

После того как сервис загрузит данные, он может сразу удалить их или же
переместить в каталог для удалённых файлов. При настройке надо указать, какой
тип удаления использовать и какой каталог использовать в качестве
корзины. Данные будут перенесены в неё таким образом, чтобы сохранялась
структура каталогов. Вы можете самостоятельно удалять данные из корзины, когда
удостоверитесь, что всё сохранено и локальная копия вам больше не нужна.

## Настройка коллекций

Настройка сервиса идёт через размещение файлов `setup.yaml` в каталогах. Этот
файл распространяет своё действие на каталог и все вложенные каталоги. Но если
во вложенной папке будет ещё один такой файл, он может выставить новое значение
параметров. Разместив несколько таких файлов в нужных местах, вы можете
настроить поведение сразу множества каталогов.

Пример `setup.yaml` (показаны настройки по умолчанию):

```yaml
termination_strategy_collection: move
termination_strategy_item: move
treat_as_collection: true
upload_limit: -1
tags: [ ]
```

#### termination_strategy_collection/termination_strategy_item

Что делать с файлами и каталогами после загрузки. Используя эту настройку, вы
можете создать неудаляемые коллекции. Например, если вы постоянно сохраняете
фото с котами, скорее всего вы захотите, чтобы этот каталог всегда был на
месте, чтобы в него можно было добавить новые фото.

Возможные варианты:

* move - переместит в каталог для удалённых материалов (значение по умолчанию).
* delete - сразу удалить.
* nothing - ничего не делать.

Учтите, что если выставлено удаление каталога, вариант `nothing` для файлов
будет проигнорирован.

#### treat_as_collection

Рассматривать каталог как коллекцию. Значение по умолчанию `true`. Вы можете
выставить его в `false`, если хотите, чтобы картинки в каталоге были включены в
родительскую коллекцию. Имя каталога при этом будет проигнорировано.

Это нужно для случаев, если у вас есть большая коллекция, например `Коты`. Но
внутри коллекции вам хотелось бы дополнительно промаркировать картинки тегами,
но всё же не разделять их на разные коллекции.

Пример структуры каталога:

```
Коты
├───setup.yaml
├───Коты толстые
│   ├───setup.yaml
│   ├───Картинка1.jpg
│   └───Картинка2.jpg
└───Коты рыжие
    ├───setup.yaml
    ├───Картинка1.jpg
    └───Картинка2.jpg
```

Таким образом вы получите одну коллекцию `Коты`, но картинки в этой коллекции
смогут иметь разные дополнительные теги.

### upload_limit

Предел количества загружаемых коллекций за раз. Например, вы хотите загружать
не более 2 коллекций из раздела "Коты" за раз, но из коллекции "Жабы" хотели бы
загружать всё, что там есть. Значение меньше нуля будет трактоваться как
"неограниченно".

На файлы настройка не распространяется, они всегда будут загружены в полном
объёме. Коллекции, в которых нет картинок и есть только одна дочерняя коллекция
в этой статистике учитываться не будут.

### Управление тегами

Для выставления дополнительных тегов, в `setup.yaml` надо заполнить
ключ `tags`. Каждый тег будет потом унаследован всеми вложенными каталогами и
картинками.

Пример заполнения:

```yaml
tags:
  - толстые коты
  - меховой шар
  - жиробас
```

## Настройка сервиса

Сервис настраивается через переменные окружения.

Пример настройки:

```shell
# адрес сайта для загрузки данных
OMOIDE_SYNC__URL=https://www.omoide.ru
# список с данными пользователей
OMOIDE_SYNC__AUTH_DATA='[{"name": "User", "login": "user123", "password": "qwerty"}]'
# каталог с картинками
OMOIDE_SYNC__ROOT_FOLDER=/home/user/pictures
# корзина для загруженных файлов
OMOIDE_SYNC__TRASH_FOLDER=/home/user/pictures_uploaded
# не обрабатывать файлы, только описать, что будет сделано
OMOIDE_SYNC__DRY_RUN=false
# уровень логирования
OMOIDE_SYNC__LOG_LEVEL=info
# уровень логирования
OMOIDE_SYNC__SUPPORTED_FORMATS=[".png", ".jpg", ".webp"]
```
