# omoide-sync

Инструмент автоматической синхронизации каталогов для
проекта [Omoide](https://github.com/IgorZyktin/omoide).

## Что делает

Проект `Omoide` упрощает хранение и поиск сохранённых картинок (например смешных фотографий с
котами). Когда фотографий становится много, а вы продолжаете их сохранять, в какой-то момент
становится просто неудобно постоянно заходить на сайт для обновления коллекции.

Данный сервис упрощает процесс, синхронизируя локальный каталог с вашим аккаунтом на сайте. Вы
сохраняете картинки на свой компьютер, а `omoide-sync` сам загружает их на сайт.

## Как работает

Сервис выполнен в виде скрипта, его можно запускать вручную или делать это автоматическими
средствами (например через `cron`). При запуске он сравнит содержимое целевого каталога с данными на
сайте и, при необходимости, загрузит на сайт новые данные.

Для работы сервису необходимо сообщить путь к файлу конфигурации. В этом файле надо описать базовые
настройки, а также указать путь к файлу с данными пользователей.

## Установка

```shell
git clone https://github.com/IgorZyktin/omoide-sync.git
cd omoide-sync
python -m venv .venv
./.venv/scripts/activate
pip install uv
uv sync
```

## Запуск

Перед запуском необходимо создать файл с настройками и файл с логинами/паролями.

Пример содержимого файла с
настройками: [omoide_sync_config.example.toml](./omoide_sync_config.example.toml)

Пример содержимого файла с данными
пользователей: [omoide_sync_credentials.example.toml](./omoide_sync_credentials.example.toml)

Пример запуска:

```shell
python -m omoide_sync C:\\Users\\Me\\omoide_sync_config.toml
```

Пример запуска без фактического внесения изменений:

```shell
python -m omoide_sync C:\\Users\\Me\\omoide_sync_config.toml --dry-run
```

## Как должен выглядеть локальный каталог

Каталог отслеживания должен быть структурирован следующим образом:

```
Корневой каталог
├───Пользователь 1
│   └───Смешные коты
│       ├───Картинка1.jpg
│       └───Картинка2.jpg
└───Пользователь 2
    └───Фотографии с жабами
        ├───Картинка1.jpg
        └───Картинка2.jpg
```

На верхнем уровне должны находиться каталоги пользователей. Внутри них может быть сколько угодно
вложенных папок с картинками. Имя каталога должно строго совпадать с названием коллекции на сайте.
Сервис будет искать записи в базе данных по имени каталога и, при необходимости, будет создавать на
сайте новые коллекции. Удалять данные сервис не умеет, он используется только для добавления новых
картинок и коллекций.

Как вариант, имя всех каталогов можно записывать
как `0ef0fd2f-0eba-4f16-af65-e2b9e5bb3ab4 Папка с котами`. Т.е. вставлять в текст UUID записи, если
такая запись уже существует. Это ускорит загрузку. Также это единственный способ, который позволит
иметь две коллекции с одинаковыми именами в одном каталоге.

После того как сервис загрузит данные, он может сразу удалить их или же переместить в каталог для
удалённых файлов. При настройке надо указать, какой тип удаления использовать и какой каталог
использовать в качестве архива. Данные будут перенесены в архив таким образом, чтобы сохранялась
структура каталогов. Вы можете самостоятельно удалять данные из архива, когда удостоверитесь, что
всё сохранено и локальная копия вам больше не нужна.

## Настройка коллекций

Настройка сервиса идёт через размещение файлов `setup.yaml` в каталогах. Этот файл меняет настройки
для каталога и всех кго вложенных элементов.

Пример `setup.yaml` (показаны настройки по умолчанию):

```yaml
init_collection = "raise"
final_collection = "move"
final_item = "move"
ephemeral = false
tags = []
limit = -1
global_limit = -1
```

#### Перед загрузкой (init_collection)

Вариант `create` позволит автоматически создавать коллекции, если их нет на сайте. Вариант `raise`
остановит загрузку, если на сайте не окажется коллекции, соответствующей каталогу.

#### После загрузки (final_collection/final_item)

Что делать с каталогами/файлами после загрузки. Используя эту настройку, вы можете создать
неудаляемые коллекции. Например, если вы постоянно сохраняете фото с котами, скорее всего вы
захотите, чтобы этот каталог всегда был на месте, чтобы в него можно было добавить новые фото.

Возможные варианты:

* `move` - переместит в архив (значение по умолчанию).
* `delete` - сразу удалить.
* `nothing` - ничего не делать.

Учтите, что если выставлено удаление каталога, вариант `nothing` для файлов
будет проигнорирован.

#### Как относиться к каталогу (ephemeral)

Если выставить этот параметр в `false`, каталог не будет рассматриваться как коллекция. Из него
просто будут взяты теги и настройки. Имя каталога при этом будет проигнорировано.

Это нужно для случаев, если у вас есть большая коллекция, например `Коты`. Но внутри коллекции вам
хотелось бы дополнительно промаркировать картинки тегами, но всё же не разделять их на разные
коллекции.

Пример структуры каталога:

```
Коты
├───setup.yaml
├───Коты толстые
│   ├───setup.yaml
│   ├───Картинка1.jpg
│   └───Картинка2.jpg
└───Коты рыжие
    ├───setup.yaml
    ├───Картинка1.jpg
    └───Картинка2.jpg
```

Таким образом вы получите одну коллекцию `Коты`, но картинки в этой коллекции смогут иметь разные
дополнительные теги.

### Ограничение на загрузку (limit/global_limit)

Предел количества загружаемых файлов и коллекций за раз. Например, вы хотите
загружать не более 2 картинок из раздела "Коты" за раз, но из коллекции "Жабы"
хотели бы загружать всё, что там есть.

Значение меньше нуля будет трактоваться как "неограниченно". Значение 0
равносильно запрету на загрузку из каталога.

Параметр `limit` действует в рамках одного каталога, параметр `global_limit` учитывает сумму
загрузок для всех дочерних элементов.

Пример - хотим загружать не более 10 картинок для каждой коллекции, но не более 50 суммарно:

```yaml
limit = 10
global_limit = 50
```

Эти параметры можно выставить независимо для каждого из пользователей и даже для каждой коллекции.

### Управление тегами (tags)

Для выставления тегов, в `setup.yaml` надо заполнить ключ `tags`. Эти теги будут применены для
коллекции, которая будет создана из текущего каталога, а также для всех картинок в этом каталоге.

Пример заполнения:

```yaml
tags:
  - толстые коты
  - меховой шар
  - жиробас
```
