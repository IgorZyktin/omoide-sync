# omoide-sync

Инструмент автоматической синхронизации каталогов для
проекта [Omoide](https://github.com/IgorZyktin/omoide).

## Что делает

Проект `Omoide` упрощает хранение и поиск сохранённых картинок, например
смешных фотографий с котами. Когда фотографий становится много, а вы, при этом,
продолжаете их сохранять, в какой-то момент становится просто неудобно
постоянно заходить на сайт для обновления коллекции.

Данный сервис упрощает процесс, синхронизируя локальный каталог с вашим
аккаунтом на сайте. Вы сохраняете картинки на свой компьютер, а `omoide-sync`
сам загружает их на сайт.

## Как работает

Вам надо сообщить сервису за каким каталогом следить, а также предоставить
логин и пароль для вашего пользователя на сайте (или сразу нескольких
пользователей). Когда он запустится, он проверит вложенные каталоги и файлы и,
при обнаружении новых, загрузит их на сайт.

Сервис выполнен в виде скрипта, его можно запускать вручную или делать это
автоматическими средствами (например через `cron`).

Каталог отслеживания должен быть структурирован следующим образом:

```
Корневой каталог
├───Пользователь 1
│   └───Смешные коты
│       ├───Картинка1.jpg
│       └───Картинка2.jpg
└───Пользователь 2
    └───Фотографии с жабами
        ├───Картинка1.jpg
        └───Картинка2.jpg
```

На верхнем уровне должны находиться каталоги пользователей. Минимум один, но
также поддерживается несколько пользователей (если у вас есть несколько
несвязанных друг с другом больших тем для картинок).

Внутри пользователей может быть сколько угодно вложенных папок с картинками.
Имя каталога должно строго совпадать с названием коллекции. Сервис будет
сравнивать содержимое каталога с данными на сайте и, при необходимости, будет
создавать на сайте новые коллекции. Удалять данные сервис не умеет, он
используется только для добавления новых картинок и коллекций.

После того как сервис загрузит данные, он переместит файлы и каталоги в
корзину. При настройке надо указать, какой каталог использовать в качестве
корзины. Данные будут перенесены в неё таким образом, чтобы сохранялась
структура каталогов. Вы можете самостоятельно удалять данные из корзины, когда
удостоверитесь, что всё сохранено и локальная копия вам больше не нужна.

## Настройка коллекций

Каталоги пользователей в корзину никогда не перемещаются. Но для остальных
можно настроить различное поведение. Для этого в каталог надо поместить
файл `config.yaml` со следующим содержимым:

```yaml
delete_after_upload: true
treat_as_collection: true
```

#### delete_after_upload

Перемещать ли каталог в корзину после загрузки. Используя эту настройку, вы
можете создать не удаляемые коллекции. Например, если вы постоянно сохраняете
фото с котами, скорее всего вы захотите, чтобы этот каталог всегда был на
месте, чтобы в него можно было добавить новые фото. По умолчанию значение
параметра `false`. Можно выставить в `true`, если коллекция должна быть
загружена один раз и больше уже не нужна.

#### treat_as_collection

Рассматривать каталог как коллекцию. Значение по умолчанию `true`. Вы можете
выставить его в `false`, если хотите, чтобы картинки в каталоге были включены в
родительскую коллекцию. Имя каталога при этом будет проигнорировано.

Это нужно для случаев, если у вас есть большая коллекция, например `Коты`. Но
внутри коллекции вам хотелось бы дополнительно промаркировать картинки тегами,
но всё же не разделять их на разные коллекции.

Пример структуры каталога:

```
Коты
├───config.yaml
├───Коты толстые
│   ├───tags.txt
│   ├───Картинка1.jpg
│   └───Картинка2.jpg
└───Коты рыжие
    ├───tags.txt
    ├───Картинка1.jpg
    └───Картинка2.jpg
```

Таким образом вы получите одну коллекцию `Коты`, но картинки в этой коллекции
смогут иметь разные дополнительные теги.

### Управление тегами

Для выставления дополнительных тегов, в каталог надо поместить файл `tags.txt`.
Каждая строка этого файла будет отдельным тегом для всех картинок в этом
каталоге.

Пример заполнения:

```
толстые коты
меховой шар
жиробас
```

## Настройка сервиса

Сервис настраивается через переменные окружения.

Пример настройки:

```shell
# адрес сайта для загрузки данных
OMOIDE_SYNC__URL=https://omoide.ru
# каталог с картинками
OMOIDE_SYNC__ROOT=/home/user/pictures
# корзина для загруженных файлов
OMOIDE_SYNC__TRASH=/home/user/pictures_uploaded
# тип аутентификации, поддерживается только JSON
OMOIDE_SYNC__AUTH_TYPE=JSON
# набор пар `имя пользователя`:`пароль`
OMOIDE_SYNC__AUTH_DATA='{"some-user": "some-password"}'
```

## Запуск сервиса

Раздел требует доработки.
