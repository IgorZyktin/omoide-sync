# omoide-sync

Инструмент автоматической синхронизации каталогов для
проекта [Omoide](https://github.com/IgorZyktin/omoide).

## Что делает

Проект `Omoide` упрощает хранение и поиск сохранённых картинок (например
смешных фотографий с котами). Когда фотографий становится много, а вы
продолжаете их сохранять, в какой-то момент становится просто неудобно
постоянно заходить на сайт для обновления коллекции.

Данный сервис упрощает процесс, синхронизируя локальный каталог с вашим
аккаунтом на сайте. Вы сохраняете картинки на свой компьютер, а `omoide-sync`
сам загружает их на сайт.

## Как работает

Сервис выполнен в виде скрипта, его можно запускать вручную или делать это
автоматическими средствами (например через `cron`).

Для работы сервис необходимо настроить через переменные окружения.

Вам надо сообщить сервису за каким каталогом следить, а также предоставить
логин и пароль для вашего пользователя на сайте (или сразу нескольких
пользователей). Когда сервис запустится, он проверит вложенные каталоги и файлы
и, при обнаружении новых, загрузит их на сайт.

## Как должен выглядеть локальный каталог

Каталог отслеживания должен быть структурирован следующим образом:

```
Корневой каталог
├───Пользователь 1
│   └───Смешные коты
│       ├───Картинка1.jpg
│       └───Картинка2.jpg
└───Пользователь 2
    └───Фотографии с жабами
        ├───Картинка1.jpg
        └───Картинка2.jpg
```

На верхнем уровне должны находиться каталоги пользователей. Внутри них может
быть сколько угодно вложенных папок с картинками. Имя каталога должно строго
совпадать с названием коллекции на сайте. Сервис будет искать записи в базе
данных по имени каталога и, при необходимости, будет создавать на сайте новые
коллекции. Удалять данные сервис не умеет, он используется только для
добавления новых картинок и коллекций.

После того как сервис загрузит данные, он может сразу удалить их или же
переместить в каталог для удалённых файлов. При настройке надо указать, какой
тип удаления использовать и какой каталог использовать в качестве
корзины. Данные будут перенесены в неё таким образом, чтобы сохранялась
структура каталогов. Вы можете самостоятельно удалять данные из корзины, когда
удостоверитесь, что всё сохранено и локальная копия вам больше не нужна.

## Настройка коллекций

Настройка сервиса идёт через размещение файлов `setup.yaml` (или `setup.yml`)
в каталогах. Этот файл меняет настройки для каталога, в котором находится,
а также для всех картинок в этом каталоге.

Пример `setup.yaml` (показаны настройки по умолчанию):

```yaml
termination_strategy_collection: move
termination_strategy_item: move
treat_as_collection: true
upload_limit: -1
tags: [ ]
```

#### termination_strategy_collection/termination_strategy_item

Что делать с каталогами/файлами после загрузки. Используя эту настройку, вы
можете создать неудаляемые коллекции. Например, если вы постоянно сохраняете
фото с котами, скорее всего вы захотите, чтобы этот каталог всегда был на
месте, чтобы в него можно было добавить новые фото.

Возможные варианты:

* `move` - переместит в каталог для удалённых материалов (значение по
  умолчанию).
* `delete` - сразу удалить.
* `nothing` - ничего не делать.

Учтите, что если выставлено удаление каталога, вариант `nothing` для файлов
будет проигнорирован.

#### treat_as_collection

Рассматривать каталог как коллекцию. Значение по умолчанию `true`. Вы можете
выставить его в `false`, если хотите, чтобы картинки в каталоге были включены в
родительскую коллекцию. Имя каталога при этом будет проигнорировано.

Это нужно для случаев, если у вас есть большая коллекция, например `Коты`. Но
внутри коллекции вам хотелось бы дополнительно промаркировать картинки тегами,
но всё же не разделять их на разные коллекции.

Пример структуры каталога:

```
Коты
├───setup.yaml
├───Коты толстые
│   ├───setup.yaml
│   ├───Картинка1.jpg
│   └───Картинка2.jpg
└───Коты рыжие
    ├───setup.yaml
    ├───Картинка1.jpg
    └───Картинка2.jpg
```

Таким образом вы получите одну коллекцию `Коты`, но картинки в этой коллекции
смогут иметь разные дополнительные теги.

**В настоящий момент этот функционал ещё не реализован до конца. 
Персональные теги к записям применяться не будут**.

### upload_limit

Предел количества загружаемых файлов и коллекций за раз. Например, вы хотите
загружать не более 2 картинок из раздела "Коты" за раз, но из коллекции "Жабы"
хотели бы загружать всё, что там есть.

Значение меньше нуля будет трактоваться как "неограниченно".

**Пока что функционал работает не до конца и ограничивает 
только загружаемые коллекции, но не отдельные файлы.**

### Управление тегами

Для выставления дополнительных тегов, в `setup.yaml` надо заполнить
ключ `tags`. Эти теги будут применены для коллекции, которая будет создана из
текущего каталога, а также для всех картинок в этом каталоге.

Пример заполнения:

```yaml
tags:
  - толстые коты
  - меховой шар
  - жиробас
```

## Настройка сервиса

Сервис настраивается через переменные окружения.

Пример настройки:

```shell
# адрес сайта для загрузки данных
OMOIDE_SYNC__URL=https://omoide.ru
# список с данными пользователей
OMOIDE_SYNC__AUTH_DATA='[{"name": "User", "login": "user123", "password": "qwerty", "root_item": "34c1b109-f742-43ad-b41b-0515ea865b9d"}]'
# каталог с картинками
OMOIDE_SYNC__ROOT_FOLDER=/home/user/pictures
# корзина для загруженных файлов
OMOIDE_SYNC__TRASH_FOLDER=/home/user/pictures_uploaded
# если true - не обрабатывать файлы, и не создавать записи, только описать, что будет сделано
OMOIDE_SYNC__DRY_RUN=false
# уровень логирования
OMOIDE_SYNC__LOG_LEVEL=info
# уровень логирования
OMOIDE_SYNC__SUPPORTED_FORMATS=[".png", ".jpg", ".jpeg", ".webp"]
# путь до экземпляра selenium
OMOIDE_SYNC__DRIVER=http://127.0.0.1:4444/wd/hub
# сколько секунд ждать окончания загрузки изображений
OMOIDE_SYNC__WAIT_FOR_UPLOAD=600
# сколько секунд ждать отрисовки страницы и обработки данных
OMOIDE_SYNC__WAIT_FOR_PAGE_LOAD=1
# сколько секунд ждать после того, как все изображения загружены
# может быть актуально если вы хотите быть уверены, что данные точно доступны
# на сайте перед продолжением дальнейших действий
OMOIDE_SYNC__WAIT_AFTER_UPLOAD=0
# раз в сколько секунд проверять статус загрузки
OMOIDE_SYNC__WAIT_STEP_FOR_UPLOAD=5
# сколько секунд ждать ответа от сервера
OMOIDE_SYNC__REQUEST_TIMEOUT=5
```

В настоящий момент для загрузки данных нужен рабочий процесс `Selenium`
т.к. обработка изображений выполняется с помощью `JavaScript` на стороне
клиента.
